<script>
// ------------------- CONFIG -------------------
const ADMIN_PASSWORD = "Leitung2026";
const LOG_PASSWORD = "Walker77";

const GITHUB_USER = "Hashikeks";
const GITHUB_REPO = "Fahrzeuge";
const GITHUB_BRANCH = "main";
const VEHICLES_FILE = "vehiclesData.json";
const LOG_FILE = "adminLog.json";
const GITHUB_TOKEN = "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";
const LOCAL_MODE = true;
// ---------------------------------------------

let vehiclesData = {};
let vehiclesSHA = null;
let adminLog = [];
let logSHA = null;

// ------------------- HELPER FUNCTIONS -------------------
function renderVehicles() {
    const container = document.getElementById("vehiclesContainer");
    container.innerHTML = "";
    for (const cat in vehiclesData) {
        if (!vehiclesData[cat] || vehiclesData[cat].length === 0) continue;
        const section = document.createElement("div"); section.classList.add("container");
        const title = document.createElement("div"); title.classList.add("title"); title.textContent = `— ${cat} —`; section.appendChild(title);
        const grid = document.createElement("div"); grid.classList.add("grid");
        vehiclesData[cat].forEach(v => {
            const card = document.createElement("div"); card.classList.add("card");
            card.innerHTML = `<img src="${v.img}"><div class="card-content"><div class="card-title">${v.name}</div><div class="card-subtitle">${v.year}</div>${v.description ? `<div class="card-description">${v.description}</div>` : ""}</div>`;
            grid.appendChild(card);
        });
        section.appendChild(grid); container.appendChild(section);
    }
}

function updateAdminLog() {
    const ul = document.getElementById("adminLog"); ul.innerHTML = "";
    adminLog.slice().reverse().forEach(e => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${e.name}</strong> wurde <em>${e.action}</em> von <strong>${e.by}</strong> in Kategorie <strong>${e.category}</strong> am ${new Date(e.timestamp).toLocaleString()}`;
        ul.appendChild(li);
    });
}

async function loadVehicles() {
    if (LOCAL_MODE) return;
    const res = await fetch(
        `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${VEHICLES_FILE}?ref=${GITHUB_BRANCH}`,
        { headers: { Authorization: `token ${GITHUB_TOKEN}` } }
    );
    const json = await res.json();
    if (!json.content) { vehiclesData = {}; return; }
    vehiclesSHA = json.sha;
    vehiclesData = JSON.parse(atob(json.content) || "{}");
    renderVehicles();
    updateRemoveVehicles();
}

async function loadLog() {
    if (LOCAL_MODE) { 
        fetch(LOG_FILE).then(res=>res.json()).then(data=>{ adminLog=data; updateAdminLog(); }); 
    } else { 
        const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${LOG_FILE}`);
        const json = await res.json(); 
        adminLog = JSON.parse(atob(json.content)); 
        logSHA = json.sha; 
        updateAdminLog(); 
    }
}

async function saveVehiclesGitHub(message = "Update Fahrzeuge") {
    if (!vehiclesSHA) { alert("SHA fehlt – bitte Seite neu laden"); return; }
    const body = {
        message,
        content: btoa(JSON.stringify(vehiclesData, null, 2)),
        branch: GITHUB_BRANCH,
        sha: vehiclesSHA
    };
    const res = await fetch(
        `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${VEHICLES_FILE}`,
        { method: "PUT", headers: { Authorization: `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" }, body: JSON.stringify(body) }
    );
    const json = await res.json();
    if (!json.content || !json.content.sha) { console.error("GitHub Save Error:", json); alert("Fehler beim Speichern auf GitHub. Siehe Console."); return; }
    vehiclesSHA = json.content.sha;
}

async function saveLogGitHub(message="Update Log") {
    if (!logSHA && !LOCAL_MODE) { alert("Log SHA fehlt!"); return; }
    const body = { message, content: btoa(JSON.stringify(adminLog,null,2)), branch: GITHUB_BRANCH, sha: logSHA };
    if (!LOCAL_MODE) {
        const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${LOG_FILE}`, { method:"PUT", headers:{"Authorization":`token ${GITHUB_TOKEN}`,"Content-Type":"application/json"}, body:JSON.stringify(body) });
        const json = await res.json(); 
        logSHA = json.content.sha;
    }
}

// ------------------- ADMIN FUNCTIONS -------------------
window.checkCode = function() {
    if (document.getElementById("adminCode").value===ADMIN_PASSWORD) {
        document.getElementById("adminPanel").style.display="block";
        document.getElementById("adminRemovePanel").style.display="block";
        document.getElementById("codeInput").style.display="none";
        alert("Admin Panel freigeschaltet!");
    } else alert("Falscher Code!");
}

window.checkLogCode = function() {
    if (document.getElementById("logCode").value===LOG_PASSWORD) {
        const panel = document.getElementById("adminPlusPanel"); 
        panel.style.display="block"; 
        setTimeout(()=>panel.classList.add("show"),10);
        document.getElementById("logCodeInput").style.display="none"; 
        updateAdminLog(); 
        alert("Versionsverlauf freigeschaltet!");
    } else alert("Falscher Code!");
}

window.addVehicle = async function() {
    const name = document.getElementById("vehicleName").value.trim();
    const year = document.getElementById("vehicleYear").value.trim();
    const description = document.getElementById("vehicleDescription").value.trim();
    const img = document.getElementById("vehicleImage").value || "https://imgur.com/HkCAjLw.png";
    const cat = document.getElementById("vehicleCategory").value;
    if (!name || !year) { alert("Bitte Name und Baujahr angeben!"); return; }
    if (!vehiclesData[cat]) vehiclesData[cat] = [];
    vehiclesData[cat].push({ name, year, description, img });
    adminLog.push({ action: "hinzugefügt", name, category: cat, by: "Admin", timestamp: new Date() });
    renderVehicles(); updateAdminLog(); updateRemoveVehicles();
    document.getElementById("vehicleName").value = ""; 
    document.getElementById("vehicleYear").value = "";
    document.getElementById("vehicleDescription").value = ""; 
    document.getElementById("vehicleImage").value = "";
    if (!LOCAL_MODE) { await saveVehiclesGitHub("Fahrzeug hinzugefügt"); await saveLogGitHub("Log aktualisiert"); }
}

window.removeVehicle = async function() {
    const cat = document.getElementById("removeCategory").value;
    const idx = document.getElementById("removeVehicle").value;
    const by = document.getElementById("removedBy").value.trim();
    if(!by){ alert("Bitte gib an, wer das Fahrzeug entfernt!"); return; }
    if(cat && idx!==""){ 
        const removed = vehiclesData[cat][idx]; 
        vehiclesData[cat].splice(idx,1);
        adminLog.push({action:"entfernt",name:removed.name,category:cat,by,timestamp:new Date()});
        renderVehicles(); updateAdminLog(); updateRemoveVehicles(); document.getElementById("removedBy").value="";
        alert("Fahrzeug entfernt!");
        if(!LOCAL_MODE){ await saveVehiclesGitHub("Fahrzeug entfernt"); await saveLogGitHub("Log aktualisiert"); }
    } else alert("Bitte Kategorie und Fahrzeug wählen.");
}

window.updateRemoveVehicles = function(){
    const cat = document.getElementById("removeCategory").value;
    const sel = document.getElementById("removeVehicle"); sel.innerHTML="<option value=''>Fahrzeug wählen</option>";
    if(cat && vehiclesData[cat]) vehiclesData[cat].forEach((v,i)=>{ const opt=document.createElement("option"); opt.value=i; opt.textContent=v.name; sel.appendChild(opt); });
}

window.clearAdminLog = async function() {
    if(confirm("Möchtest du wirklich den gesamten Versionsverlauf löschen?")){
        adminLog=[]; updateAdminLog();
        const panel = document.getElementById("adminPlusPanel"); panel.classList.remove("show"); setTimeout(()=>panel.style.display="none",500);
        if(!LOCAL_MODE) await saveLogGitHub("Versionsverlauf gelöscht");
        alert("Versionsverlauf gelöscht!");
    }
}

// ------------------- INITIAL -------------------
(async () => {
    await loadVehicles();
    await loadLog();
})();
</script>
